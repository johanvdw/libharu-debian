From: Antony Dovgal <tony@daylessday.org>
Date: Tue, 16 Dec 2008 18:01:02 +0300
Subject: [PATCH] fix bug #13 (various fixes)

---
 src/hpdf_annotation.c    |    4 ++--
 src/hpdf_destination.c   |    6 ++++--
 src/hpdf_doc.c           |   10 ++++++++--
 src/hpdf_ext_gstate.c    |    2 +-
 src/hpdf_font_tt.c       |    4 ++--
 src/hpdf_fontdef_tt.c    |    2 +-
 src/hpdf_fontdef_type1.c |    4 ++--
 src/hpdf_list.c          |    2 +-
 src/hpdf_streams.c       |   11 ++++++++---
 9 files changed, 29 insertions(+), 16 deletions(-)

diff --git a/src/hpdf_annotation.c b/src/hpdf_annotation.c
index 9cfa03d..e190779 100644
--- a/src/hpdf_annotation.c
+++ b/src/hpdf_annotation.c
@@ -20,7 +20,7 @@
 #include "hpdf_annotation.h"
 #include "hpdf.h"
 
-const static char  *HPDF_ANNOT_TYPE_NAMES[] = {
+static const char  *HPDF_ANNOT_TYPE_NAMES[] = {
                                         "Text",
                                         "Link",
                                         "Sound",
@@ -37,7 +37,7 @@ const static char  *HPDF_ANNOT_TYPE_NAMES[] = {
                                         "3D"
                                         };
 
-const static char  *HPDF_ANNOT_ICON_NAMES_NAMES[] = {
+static const char  *HPDF_ANNOT_ICON_NAMES_NAMES[] = {
                                         "Comment",
                                         "Key",
                                         "Note",
diff --git a/src/hpdf_destination.c b/src/hpdf_destination.c
index 1874898..d3f5744 100644
--- a/src/hpdf_destination.c
+++ b/src/hpdf_destination.c
@@ -85,8 +85,10 @@ HPDF_Destination_Validate (HPDF_Destination  dst)
         return HPDF_FALSE;
 
     target = (HPDF_Page)HPDF_Array_GetItem (dst, 0, HPDF_OCLASS_DICT);
-    if (!HPDF_Page_Validate (target))
-        return HPDF_SetError (dst->error, HPDF_INVALID_PAGE, 0);
+    if (!HPDF_Page_Validate (target)) {
+	    HPDF_SetError (dst->error, HPDF_INVALID_PAGE, 0);
+        return HPDF_FALSE;
+    }
 
     return HPDF_TRUE;
 }
diff --git a/src/hpdf_doc.c b/src/hpdf_doc.c
index 64c8931..270fff3 100644
--- a/src/hpdf_doc.c
+++ b/src/hpdf_doc.c
@@ -1190,10 +1190,11 @@ HPDF_SetCurrentEncoder  (HPDF_Doc    pdf,
         return HPDF_GetError (pdf);
 
     encoder = HPDF_GetEncoder (pdf, encoding_name);
-    pdf->cur_encoder = encoder;
 
-    if (!pdf)
+    if (!encoder)
         return HPDF_GetError (pdf);
+    
+	pdf->cur_encoder = encoder;
 
     return HPDF_OK;
 }
@@ -1285,6 +1286,11 @@ HPDF_GetFont  (HPDF_Doc          pdf,
             return NULL;
         }
 
+        if (!encoder) {
+            HPDF_CheckError (&pdf->error);
+            return NULL;
+        }
+
         font = HPDF_Doc_FindFont (pdf, font_name, encoder->name);
     } else {
         font = HPDF_Doc_FindFont (pdf, font_name, encoding_name);
diff --git a/src/hpdf_ext_gstate.c b/src/hpdf_ext_gstate.c
index df3d8f6..a4ac011 100644
--- a/src/hpdf_ext_gstate.c
+++ b/src/hpdf_ext_gstate.c
@@ -20,7 +20,7 @@
 #include "hpdf_ext_gstate.h"
 #include "hpdf.h"
 
-const static char  *HPDF_BM_NAMES[] = {
+static const char  *HPDF_BM_NAMES[] = {
                                       "Normal",
                                       "Multiply",
                                       "Screen",
diff --git a/src/hpdf_font_tt.c b/src/hpdf_font_tt.c
index 01c8a12..2720bc4 100644
--- a/src/hpdf_font_tt.c
+++ b/src/hpdf_font_tt.c
@@ -247,7 +247,7 @@ CharWidth (HPDF_Font  font,
 }
 
 
-HPDF_TextWidth
+static HPDF_TextWidth
 TextWidth  (HPDF_Font         font,
             const HPDF_BYTE  *text,
             HPDF_UINT         len)
@@ -283,7 +283,7 @@ TextWidth  (HPDF_Font         font,
 }
 
 
-HPDF_UINT
+static HPDF_UINT
 MeasureText (HPDF_Font          font,
              const HPDF_BYTE   *text,
              HPDF_UINT          len,
diff --git a/src/hpdf_fontdef_tt.c b/src/hpdf_fontdef_tt.c
index f5d24c7..2596f29 100644
--- a/src/hpdf_fontdef_tt.c
+++ b/src/hpdf_fontdef_tt.c
@@ -1225,7 +1225,7 @@ CheckCompositGryph  (HPDF_FontDef   fontdef,
 {
     HPDF_TTFontDefAttr attr = (HPDF_TTFontDefAttr)fontdef->attr;
     HPDF_UINT offset = attr->glyph_tbl.offsets[gid];
-   // HPDF_UINT len = attr->glyph_tbl.offsets[gid + 1] - offset;
+    /* HPDF_UINT len = attr->glyph_tbl.offsets[gid + 1] - offset; */
     HPDF_STATUS ret;
 
     HPDF_PTRACE ((" CheckCompositGryph\n"));
diff --git a/src/hpdf_fontdef_type1.c b/src/hpdf_fontdef_type1.c
index 302184b..0c7420b 100644
--- a/src/hpdf_fontdef_type1.c
+++ b/src/hpdf_fontdef_type1.c
@@ -427,8 +427,8 @@ HPDF_Type1FontDef_Duplicate  (HPDF_MMgr     mmgr,
     fontdef->type = src->type;
     fontdef->valid = src->valid;
 
-    // copy data of attr,widths
-    // attention to charset
+    /* copy data of attr,widths
+     attention to charset */
     return NULL;
 }
 
diff --git a/src/hpdf_list.c b/src/hpdf_list.c
index da7fa75..71caa77 100644
--- a/src/hpdf_list.c
+++ b/src/hpdf_list.c
@@ -275,7 +275,7 @@ HPDF_List_Clear  (HPDF_List  list)
  *
  */
 
-HPDF_STATUS
+static HPDF_STATUS
 Resize  (HPDF_List   list,
          HPDF_UINT   count)
 {
diff --git a/src/hpdf_streams.c b/src/hpdf_streams.c
index 2a0f662..aa0491d 100644
--- a/src/hpdf_streams.c
+++ b/src/hpdf_streams.c
@@ -1072,8 +1072,13 @@ HPDF_MemStream_SeekFunc  (HPDF_Stream      stream,
     } else if (mode == HPDF_SEEK_END)
         pos = stream->size - pos;
 
-    if (pos > stream->size || stream->size == 0)
+    if (pos > stream->size) {
         return HPDF_SetError (stream->error, HPDF_STREAM_EOF, 0);
+    }
+
+    if (stream->size == 0) {
+        return HPDF_OK;
+    }
 
     attr->r_ptr_idx = pos / attr->buf_siz;
     attr->r_pos = pos % attr->buf_siz;
@@ -1164,11 +1169,11 @@ HPDF_MemStream_New  (HPDF_MMgr  mmgr,
 
     HPDF_PTRACE((" HPDF_MemStream_New\n"));
 
-    // Create new HPDF_Stream object.
+    /* Create new HPDF_Stream object. */
     stream = (HPDF_Stream)HPDF_GetMem (mmgr, sizeof(HPDF_Stream_Rec));
 
     if (stream) {
-        // Create attribute struct.
+        /* Create attribute struct. */
         HPDF_MemStreamAttr attr = (HPDF_MemStreamAttr)HPDF_GetMem (mmgr,
                 sizeof(HPDF_MemStreamAttr_Rec));
 
-- 
